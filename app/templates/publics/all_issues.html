{% extends "base.html" %}

{%block title%}CITK HOSTEL MANAGEMENT SYSTEM | All Issues{%endblock%}


{% block content %}

<div class="issues-page-wrapper" style="margin-bottom: 50px;">
  <h2 class="issues-page-title">
    All Issues – {{ hostel }}
  </h2>
  

  <div class="issues-vertical-list">
    {% for c in complaints %}
    
    <div class="issue-row-card {% if loop.index <= 3 %}top-issue{% endif %}">

      
      <!-- <div class="issue-row-index">
        {{ loop.index }}
      </div> -->

      
      <div class="issue-row-content">

        <!-- HEADER -->
        <div class="issue-row-header">
           <div class="issue-row-index">
        {{ loop.index }}
      </div>
<span class="issue-row-category">{{ c.category }}</span>

          {% if current_user.role == 'admin' %}
          <!-- ADMIN STATUS CONTROL -->
          <form
            method="POST"
            action="{{ url_for('admin.update_status', id=c.id) }}"
            class="status-form">

            <select
              name="status"
              class="status-select"
              onchange="this.form.submit()">

              <option value="Pending"
                {% if c.status == 'Pending' %}selected{% endif %}>
                Pending
              </option>

              <option value="In Progress"
                {% if c.status == 'In Progress' %}selected{% endif %}>
                In Progress
              </option>

              <option value="Resolved"
                {% if c.status == 'Resolved' %}selected{% endif %}>
                Resolved
              </option>

            </select>
          </form>

          {% else %}
         
          <span class="issue-row-status
            {% if c.status == 'Pending' %}status-pending
            {% elif c.status == 'In Progress' %}status-progress
            {% else %}status-resolved{% endif %}">
            {{ c.status }}
          </span>
          {% endif %}
        </div>

        
        <p class="issue-row-desc">
          {{ c.description }}
        </p>

        
        {% if c.image %}
        <img
          src="{{ url_for('static', filename='complaint_images/' ~ c.image) }}"
          class="issue-row-image">
        {% endif %}

        
        <div class="issue-row-time">
          {{ c.date_posted.strftime('%d %b %Y • %I:%M %p') }}
        </div>

      </div>

    
      <div class="issue-row-actions">
        <button
          class="issue-upvote-btn"
          data-id="{{ c.id }}">
          +
        </button>

        <span
          class="issue-upvote-count"
          id="vote-count-{{ c.id }}">
          {{ c.upvotes }}
        </span>
      </div>

    </div>
    {% endfor %}
  </div>
</div>

<!-- UPVOTE SCRIPT -->
<script>
function animateCount(el, start, end) {
  let current = start;
  const interval = setInterval(() => {
    current++;
    el.innerText = current;
    if (current >= end) clearInterval(interval);
  }, 40);
}

document.querySelectorAll('.issue-upvote-btn').forEach(btn => {
  btn.addEventListener('click', () => {

    const id = btn.dataset.id;
    const countEl = document.getElementById(`vote-count-${id}`);
    const oldCount = parseInt(countEl.innerText);

    fetch(`/complaint/${id}/upvote`, {
      method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        animateCount(countEl, oldCount, data.upvotes);
        btn.disabled = true;
        btn.innerText = "✔";
        btn.classList.add('voted');
      } else {
        alert("You already upvoted this issue.");
      }
    });
  });
});
</script>

{% endblock %}
